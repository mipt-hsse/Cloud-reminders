<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–£—Ä–æ–∫ –ø–æ CSRF-—Ç–æ–∫–µ–Ω–∞–º –≤ Django</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        button.danger { background-color: #dc3545; }
        .result { margin-top: 10px; padding: 10px; border-radius: 4px; background-color: #e9ecef; white-space: pre-wrap; }
        .error { color: #dc3545; font-weight: bold; }
        .success { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è –£—Ä–æ–∫ –ø–æ CSRF-—Ç–æ–∫–µ–Ω–∞–º –≤ Django –∏ `fetch`</h1>
        
        {% csrf_token %}
        <div class="section">
            <h2>1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞</h2>
            <p>Django –º–∞—Å–∫–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω –≤ —Å–∫—Ä—ã—Ç–æ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞, –∫–æ—Ç–æ—Ä–æ–µ –º—ã –∏–∑–≤–ª–µ–∫–∞–µ–º —Å –ø–æ–º–æ—â—å—é JavaScript.</p>
            <p><strong>–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω:</strong> <code id="display-token">–ò–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞...</code></p>
        </div>
        
        <div class="section">
            <h2>2. –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π POST-–∑–∞–ø—Ä–æ—Å (–£–°–ü–ï–•)</h2>
            <p>–¢–æ–∫–µ–Ω **–ø—Ä–∞–≤–∏–ª—å–Ω–æ** –¥–æ–±–∞–≤–ª–µ–Ω –≤ HTTP-–∑–∞–≥–æ–ª–æ–≤–æ–∫ <code>X-CSRFToken</code>.</p>
            <button onclick="sendSafePost()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å POST (—Å —Ç–æ–∫–µ–Ω–æ–º)</button>
            <div id="safe-post-result" class="result">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
        </div>

        <div class="section">
            <h2>3. –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π POST-–∑–∞–ø—Ä–æ—Å (–û–®–ò–ë–ö–ê 403)</h2>
            <p>–¢–æ–∫–µ–Ω **–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç** –≤ HTTP-–∑–∞–≥–æ–ª–æ–≤–∫–µ. Django –≤–µ—Ä–Ω–µ—Ç 403 Forbidden.</p>
            <button class="danger" onclick="sendUnsafePost()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å POST (–ë–ï–ó —Ç–æ–∫–µ–Ω–∞)</button>
            <div id="unsafe-post-result" class="result">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
        </div>
    </div>

    <script>
        // === 1. –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –¢–û–ö–ï–ù–ê ===
        // –≠—Ç–æ –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω, –∫–æ—Ç–æ—Ä—ã–π –ú–ï–ù–Ø–ï–¢–°–Ø –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // –û—Ç–æ–±—Ä–∞–∑–∏–º –µ–≥–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        document.getElementById('display-token').textContent = csrftoken;

        // === 2. –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ó–ê–ì–û–õ–û–í–ö–û–í (–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ) ===
        function getAuthHeaders(includeCsrf = true) {
            const headers = {
                'Content-Type': 'application/json',
            };
            
            // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —à–∞–≥: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
            if (includeCsrf) {
                headers['X-CSRFToken'] = csrftoken;
            }

            return headers;
        }

        // === 3. –û–¢–ü–†–ê–í–ö–ê –ë–ï–ó–û–ü–ê–°–ù–û–ì–û –ó–ê–ü–†–û–°–ê ===
        async function sendSafePost() {
            const resultDiv = document.getElementById('safe-post-result');
    // ... (–∫–æ–¥ –¥–æ try)
    try {
        const response = await fetch('/api/csrf/post/', {
            method: 'POST',
            headers: getAuthHeaders(true), 
            body: JSON.stringify({ message: "Hello, safe world!" }),
            credentials: 'include'
        });

        // üõë –ò–ó–ú–ï–ù–ò–¢–ï –≠–¢–£ –°–¢–†–û–ö–£
        // const data = await response.json(); 
        
        // üöÄ –ù–û–í–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –∫–∞–∫ —Ç–µ–∫—Å—Ç
        const textData = await response.text(); 
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
        if (response.ok) {
            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 200/201, –Ω–æ –ø—Ä–∏—à–µ–ª HTML, —Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –≤ –ª–æ–≥–∏–∫–µ DRF/View.
            resultDiv.innerHTML = `<p class="success">–£–°–ü–ï–•: ${response.status} OK</p>
                <p>–¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞:</p>${textData}`;
        } else {
            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 403, 404, 500, —Ç–æ —ç—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—à–∏–±–∫–∏.
            resultDiv.innerHTML = `<p class="error">–û–®–ò–ë–ö–ê: ${response.status} ${response.statusText}</p>
                <p>–¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ (–≤–µ—Ä–æ—è—Ç–Ω–æ, HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—à–∏–±–∫–∏):</p> ${textData.substring(0, 500)}`;
        }

    } catch (error) {
        resultDiv.innerHTML = `<p class="error">–û–®–ò–ë–ö–ê FETCH: ${error.message}</p>`;
    }
}

        // === 4. –û–¢–ü–†–ê–í–ö–ê –ù–ï–ë–ï–ó–û–ü–ê–°–ù–û–ì–û –ó–ê–ü–†–û–°–ê (–±–µ–∑ —Ç–æ–∫–µ–Ω–∞) ===
        async function sendUnsafePost() {
            const resultDiv = document.getElementById('unsafe-post-result');
            resultDiv.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

            try {
                const response = await fetch('/api/csrf/post/', {
                    method: 'POST',
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ë–ï–ó —Ç–æ–∫–µ–Ω–∞
                    headers: getAuthHeaders(false), 
                    body: JSON.stringify({ message: "Hello, unsafe world!" }),
                    credentials: 'include'
                });

                const text = await response.text();
                
                if (response.status === 403) {
                    resultDiv.innerHTML = `<p class="error">–û–ñ–ò–î–ê–ï–ú–ê–Ø –û–®–ò–ë–ö–ê: 403 Forbidden</p>
                        <p>Django –≤—ã–¥–∞–ª: <strong>CSRF verification failed</strong></p>
                        <p>–¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º): ${text}</p>`;
                } else if (response.ok) {
                     resultDiv.innerHTML = `<p class="success">–ù–ï–û–ñ–ò–î–ê–ù–ù–´–ô –£–°–ü–ï–•: ${response.status} OK</p>`;
                } else {
                    resultDiv.innerHTML = `<p class="error">–û–®–ò–ë–ö–ê: ${response.status} ${response.statusText}</p>
                        <p>–¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞: ${text}</p>`;
                }

            } catch (error) {
                resultDiv.innerHTML = `<p class="error">–û–®–ò–ë–ö–ê FETCH: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>