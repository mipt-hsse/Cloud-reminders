#!/bin/bash

set -e

echo "ğŸš€ Starting deployment..."

# ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²
echo "ğŸ›‘ Stopping existing containers..."
docker-compose -f docker-compose.prod.yml down

# Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²
echo "ğŸ”¨ Building images..."
docker-compose -f docker-compose.prod.yml build

# Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
echo "ğŸ“¦ Collecting static files..."
docker-compose -f docker-compose.prod.yml run --rm web python manage.py collectstatic --noinput

# ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹
echo "ğŸ“‹ Applying migrations..."
docker-compose -f docker-compose.prod.yml run --rm web python manage.py migrate

# Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
echo "â–¶ï¸ Starting services..."
docker-compose -f docker-compose.prod.yml up -d

echo "âœ… Deployment completed!"
echo "ğŸ“Š Checking services..."
docker-compose -f docker-compose.prod.yml ps